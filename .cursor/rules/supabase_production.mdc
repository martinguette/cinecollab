---
description: Reglas especÃ­ficas para manejo seguro de Supabase en producciÃ³n
globs: supabase/**/*, src/integrations/supabase/**/*
alwaysApply: true
---

# ğŸ—„ï¸ **REGLAS DE SUPABASE EN PRODUCCIÃ“N**

## **âš ï¸ CONTEXTO CRÃTICO**

- **Base de datos Supabase en PRODUCCIÃ“N con usuarios reales**
- **Datos de watchlists, pelÃ­culas y usuarios reales**
- **NUNCA comprometer la integridad de los datos existentes**

---

## **ğŸ”’ OPERACIONES SEGURAS EN SUPABASE**

### **âœ… OPERACIONES PERMITIDAS:**

```sql
-- Crear nuevas tablas (seguro)
CREATE TABLE IF NOT EXISTS public.new_table (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE,
  -- otros campos...
);

-- Agregar columnas (seguro)
ALTER TABLE public.existing_table
ADD COLUMN IF NOT EXISTS new_column text DEFAULT 'default_value';

-- Crear polÃ­ticas RLS (seguro)
DROP POLICY IF EXISTS "policy_name" ON public.table_name;
CREATE POLICY "policy_name" ON public.table_name
  FOR SELECT USING (auth.uid() = user_id);

-- Habilitar RLS (seguro)
ALTER TABLE public.table_name ENABLE ROW LEVEL SECURITY;
```

### **âŒ OPERACIONES PROHIBIDAS:**

```sql
-- NUNCA hacer esto en producciÃ³n:
DROP TABLE public.existing_table;
DELETE FROM public.existing_table;
TRUNCATE public.existing_table;
ALTER TABLE public.existing_table DROP COLUMN existing_column;
ALTER TABLE public.existing_table ALTER COLUMN existing_column TYPE new_type;
```

---

## **ğŸ›¡ï¸ VALIDACIÃ“N DE SCRIPTS SQL**

### **Checklist obligatorio antes de ejecutar:**

- [ ] **Â¿El script solo crea nuevas tablas?** â†’ âœ… Seguro
- [ ] **Â¿El script solo agrega columnas?** â†’ âœ… Seguro
- [ ] **Â¿El script solo crea polÃ­ticas RLS?** â†’ âœ… Seguro
- [ ] **Â¿El script elimina datos existentes?** â†’ âŒ PELIGROSO
- [ ] **Â¿El script modifica datos existentes?** â†’ âŒ PELIGROSO

### **Patrones seguros identificados:**

```sql
-- âœ… PatrÃ³n seguro: Crear tablas para nuevas funcionalidades
CREATE TABLE IF NOT EXISTS public.user_favorites (...);
CREATE TABLE IF NOT EXISTS public.user_watched (...);

-- âœ… PatrÃ³n seguro: PolÃ­ticas RLS con DROP IF EXISTS
DROP POLICY IF EXISTS "old_policy" ON public.table_name;
CREATE POLICY "new_policy" ON public.table_name ...;

-- âœ… PatrÃ³n seguro: Habilitar RLS
ALTER TABLE public.new_table ENABLE ROW LEVEL SECURITY;
```

---

## **ğŸ” VERIFICACIÃ“N DE IMPACTO EN DATOS**

### **Antes de ejecutar cualquier script:**

1. **Identificar tablas afectadas:**

   - `public.watchlists` â†’ Contiene watchlists de usuarios reales
   - `public.watchlist_movies` â†’ Contiene pelÃ­culas de usuarios reales
   - `public.watchlist_members` â†’ Contiene miembros de watchlists reales
   - `auth.users` â†’ Contiene usuarios reales

2. **Verificar que NO se toquen estas tablas:**

   - âŒ No modificar estructura de tablas existentes
   - âŒ No eliminar datos de estas tablas
   - âŒ No cambiar tipos de datos existentes

3. **Confirmar que solo se agreguen:**
   - âœ… Nuevas tablas para nuevas funcionalidades
   - âœ… Nuevas polÃ­ticas RLS
   - âœ… Nuevas columnas opcionales

---

## **ğŸ“‹ ESTRUCTURA DE DATOS ACTUAL**

### **Tablas existentes (NO TOCAR):**

```sql
-- Tabla de watchlists (usuarios reales)
public.watchlists
â”œâ”€â”€ id (uuid)
â”œâ”€â”€ name (text)
â”œâ”€â”€ description (text)
â”œâ”€â”€ owner_id (uuid) â†’ auth.users(id)
â”œâ”€â”€ created_at (timestamp)
â””â”€â”€ updated_at (timestamp)

-- Tabla de pelÃ­culas en watchlists (datos reales)
public.watchlist_movies
â”œâ”€â”€ id (uuid)
â”œâ”€â”€ watchlist_id (uuid) â†’ watchlists(id)
â”œâ”€â”€ movie_id (integer)
â”œâ”€â”€ movie_type (text)
â”œâ”€â”€ added_by (uuid) â†’ auth.users(id)
â””â”€â”€ added_at (timestamp)

-- Tabla de miembros de watchlists (usuarios reales)
public.watchlist_members
â”œâ”€â”€ id (uuid)
â”œâ”€â”€ watchlist_id (uuid) â†’ watchlists(id)
â”œâ”€â”€ user_id (uuid) â†’ auth.users(id)
â”œâ”€â”€ role (text)
â””â”€â”€ joined_at (timestamp)
```

### **Nuevas tablas (SEGURO AGREGAR):**

```sql
-- Tabla de favoritos (nueva funcionalidad)
public.user_favorites
â”œâ”€â”€ id (uuid)
â”œâ”€â”€ user_id (uuid) â†’ auth.users(id)
â”œâ”€â”€ media_id (integer)
â”œâ”€â”€ media_type (text)
â””â”€â”€ added_at (timestamp)

-- Tabla de visto (nueva funcionalidad)
public.user_watched
â”œâ”€â”€ id (uuid)
â”œâ”€â”€ user_id (uuid) â†’ auth.users(id)
â”œâ”€â”€ media_id (integer)
â”œâ”€â”€ media_type (text)
â””â”€â”€ watched_at (timestamp)
```

---

## **ğŸš¨ ALERTAS CRÃTICAS**

### **Si detectas estos patrones, DETENER inmediatamente:**

- `DROP TABLE public.watchlists`
- `DROP TABLE public.watchlist_movies`
- `DROP TABLE public.watchlist_members`
- `DELETE FROM public.watchlists`
- `DELETE FROM public.watchlist_movies`
- `DELETE FROM public.watchlist_members`
- `TRUNCATE` en cualquier tabla existente
- `ALTER TABLE` que modifique columnas existentes

### **Comandos de emergencia:**

- **Detener ejecuciÃ³n** si hay riesgo de pÃ©rdida de datos
- **Informar al usuario** sobre cualquier riesgo potencial
- **Sugerir backup** antes de cambios importantes
- **Validar impacto** antes de proceder

---

## **ğŸ’¡ MEJORES PRÃCTICAS**

### **Para nuevas funcionalidades:**

1. **Crear nuevas tablas** en lugar de modificar existentes
2. **Usar `CREATE TABLE IF NOT EXISTS`** para evitar errores
3. **Mantener referencias a `auth.users(id)`** para consistencia
4. **Agregar polÃ­ticas RLS** apropiadas para nuevas tablas

### **Para polÃ­ticas RLS:**

1. **Usar `DROP POLICY IF EXISTS`** antes de crear nuevas
2. **Mantener polÃ­ticas existentes** que funcionan
3. **Verificar que no bloqueen acceso existente**
4. **Probar polÃ­ticas** en entorno de desarrollo

### **Para migraciones:**

1. **Solo agregar, nunca eliminar**
2. **Mantener retrocompatibilidad**
3. **Usar valores por defecto** para nuevas columnas
4. **Probar en entorno de desarrollo** antes de producciÃ³n

---

**ğŸ¯ OBJETIVO: Mantener la integridad de los datos de usuarios reales mientras se agregan nuevas funcionalidades de manera segura y sin interrupciones.**
