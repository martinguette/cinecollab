---
description: Sistema de internacionalizaciÃ³n reactivo sin recargas de pÃ¡gina
globs: src/**/*.tsx, src/**/*.ts
alwaysApply: true
---

# ðŸŒ **SISTEMA I18N REACTIVO**

## **âš¡ PRINCIPIO FUNDAMENTAL**

- **NUNCA recargar la pÃ¡gina** para cambio de idioma
- **Siempre usar contexto reactivo** para sincronizaciÃ³n
- **Persiste en localStorage** automÃ¡ticamente
- **Cambios instantÃ¡neos** en toda la aplicaciÃ³n

---

## **ðŸŽ¯ PATRÃ“N REQUERIDO**

### **âœ… USAR: LanguageContext + useLanguage**

```tsx
// âœ… CORRECTO: Usar el contexto reactivo
import { useLanguage } from '@/context/LanguageContext';

export function MyComponent() {
  const { currentLanguage, changeLanguage, isChanging } = useLanguage();

  const handleLanguageChange = async (lang: string) => {
    await changeLanguage(lang); // Sin reload, cambio instantÃ¡neo
  };

  return (
    <Button disabled={isChanging}>
      {isChanging ? <Loader2 /> : <Globe />}
      Current: {currentLanguage}
    </Button>
  );
}
```

### **âŒ PROHIBIDO: window.location.reload()**

```tsx
// âŒ INCORRECTO: Recargar pÃ¡gina
const handleLanguageChange = async (lang: string) => {
  await i18n.changeLanguage(lang);
  window.location.reload(); // âŒ NUNCA HACER ESTO
};

// âŒ INCORRECTO: Usar i18n directamente
const { i18n } = useTranslation();
// Usar useLanguage() en su lugar
```

---

## **ðŸ”§ IMPLEMENTACIÃ“N**

### **1. DetecciÃ³n AutomÃ¡tica de Idioma:**

```tsx
// src/lib/i18n.ts
detection: {
  order: ['localStorage', 'navigator', 'htmlTag', 'path', 'subdomain'],
  caches: ['localStorage'],
  lookupLocalStorage: 'i18nextLng',
  // Convierte cÃ³digos de idioma del navegador a nuestros idiomas soportados
  convertDetectedLanguage: (lng) => {
    const supportedLanguages = ['en', 'es'];
    const detectedLang = lng.split('-')[0].toLowerCase();
    return supportedLanguages.includes(detectedLang) ? detectedLang : 'en';
  },
}
```

### **2. Estructura del Contexto:**

```tsx
// src/context/LanguageContext.tsx
export interface LanguageContextType {
  currentLanguage: string; // Estado actual del idioma
  changeLanguage: (lang: string) => Promise<void>; // Cambio reactivo
  isChanging: boolean; // Estado de carga
}

// Hook personalizado
export function useLanguage(): LanguageContextType {
  // ValidaciÃ³n de contexto
  // Retorna interfaz limpia
}
```

### **3. Provider en App:**

```tsx
// src/main.tsx
<BrowserRouter>
  <AuthProvider>
    <LanguageProvider>
      {' '}
      {/* âœ… Wrappear toda la app */}
      <App />
    </LanguageProvider>
  </AuthProvider>
</BrowserRouter>
```

### **4. Componentes que cambian idioma:**

```tsx
// LanguageSwitcher, Settings, etc.
export function LanguageSwitcher() {
  const { currentLanguage, changeLanguage, isChanging } = useLanguage();

  // âœ… Cambio sin reload
  const handleChange = (lang: string) => changeLanguage(lang);

  // âœ… UI reactiva con estados de carga
  return (
    <Button disabled={isChanging}>
      {isChanging ? <Loader2 className="animate-spin" /> : <Globe />}
    </Button>
  );
}
```

---

## **ðŸ“‹ BENEFICIOS DEL PATRÃ“N**

### **âœ… DetecciÃ³n Inteligente:**

- **DetecciÃ³n automÃ¡tica**: Usa idioma del navegador/dispositivo del usuario
- **Prioridad correcta**: localStorage > navegador > HTML > fallback
- **ConversiÃ³n inteligente**: 'es-ES', 'es-MX' â†’ 'es' | 'en-US', 'en-GB' â†’ 'en'
- **Persistencia manual**: Recuerda selecciÃ³n del usuario permanentemente

### **âœ… Rendimiento Excelente:**

- **Sin recargas**: Cambio instantÃ¡neo (< 100ms)
- **Re-render mÃ­nimo**: Solo componentes con `useTranslation()`
- **Memoria insignificante**: Solo un string en contexto
- **Persistencia automÃ¡tica**: localStorage manejado internamente

### **âœ… UX Superior:**

- **Cambio fluido**: Sin parpadeos ni interrupciones
- **Estados visuales**: Indicadores de carga
- **Feedback inmediato**: Usuario ve cambio al instante
- **Consistencia**: Toda la app cambia simultÃ¡neamente

### **âœ… Mantenimiento:**

- **PatrÃ³n Ãºnico**: Todos los componentes usan `useLanguage()`
- **Centralizado**: LÃ³gica de idioma en un solo lugar
- **Testeable**: FÃ¡cil de mockear para pruebas
- **Escalable**: Agregar idiomas es trivial

---

## **ðŸš¨ VALIDACIONES CRÃTICAS**

### **Antes de implementar cambio de idioma:**

- [ ] **Â¿Usa `useLanguage()` hook?** â†’ âœ… Requerido
- [ ] **Â¿Evita `window.location.reload()`?** â†’ âœ… Prohibido
- [ ] **Â¿Maneja estado `isChanging`?** â†’ âœ… Para UX
- [ ] **Â¿Persiste en localStorage?** â†’ âœ… AutomÃ¡tico en contexto

### **Componentes afectados:**

```tsx
// âœ… Estos componentes deben usar useLanguage():
- LanguageSwitcher
- Settings/Preferences
- User Profile
- Navigation menus
- Cualquier componente que cambie idioma

// âœ… Estos siguen usando useTranslation():
- Todos los demÃ¡s componentes (para mostrar texto)
- No necesitan cambiar, solo consumir traducciones
```

---

## **ðŸ” DEBUGGING**

### **Problemas comunes:**

```tsx
// âŒ Error: "useLanguage must be used within LanguageProvider"
// âœ… SoluciÃ³n: Verificar que LanguageProvider wrappee el componente

// âŒ Error: Traducciones no se actualizan
// âœ… SoluciÃ³n: Verificar que useTranslation() estÃ© en componente

// âŒ Error: Idioma no persiste
// âœ… SoluciÃ³n: Verificar localStorage en changeLanguage()
```

### **Herramientas de debug:**

```tsx
// En desarrollo, agregar logs:
const { currentLanguage } = useLanguage();
console.log('Current language:', currentLanguage);

// Verificar localStorage:
console.log('Stored language:', localStorage.getItem('i18nextLng'));
```

---

## **ðŸ“ˆ MÃ‰TRICAS DE Ã‰XITO**

- **Tiempo de cambio**: < 100ms (vs 2-5s con reload)
- **Re-renders**: Solo componentes con texto (vs toda la app)
- **Memoria**: < 1KB adicional (vs recarga completa)
- **UX Score**: Cambio fluido sin interrupciones

---

**ðŸŽ¯ OBJETIVO: Cambio de idioma instantÃ¡neo, fluido y sin interrupciones para una experiencia de usuario superior.**
